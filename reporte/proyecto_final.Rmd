---
title:    "Proyecto Final Análisis de Supervivencia"
subtitle: "Análisis de Supervivencia para fallas de motor"
author:  
  - "Víctor Samayoa \t- 175750"
  - "Saúl Caballero \t- 133930"
  - "Delia Del Águila \t- 167188"
output: 
  pdf_document:
    number_sections: true
    toc_depth: 2
fontsize: 12pt
header-includes:
  - \usepackage[spanish]{babel}
  - \decimalpoint
documentclass: "article"
# bibliography: "references.bib"
---


```{r, warning=FALSE, message=FALSE, echo = FALSE}
# Cargo de librerias
library(dplyr)
library(sqldf)
library(readr)
library(ggplot2)
library(ggthemes)
library(here)
library(TraMineR)
library(reshape2)
library(tidyr)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
datos <- read_rds(
  here::here("datos/datos.rds")
) %>% 
  select("id":"sensor_21", "delta")
```

# Introducción 

Se obtuvo la base de datos usada para la competencia de desafío de pronóstico en la Conferencia Internacional sobre pronóstico y gestión de la salud (PHM08). [1]

La base consiste en múltiples series de tiempo multivariadas. Cada serie es de un motor diferente pero de un mismo tipo. Cada motor arranca con diferentes grados de desgaste inicial y variación de fabricación que es desconocido para el usuario. Este desgaste y variación se considera normal, es decir, no se considera una condición de falla. Hay tres configuraciones operativas que tienen un efecto sustancial en el rendimiento del motor, además se cuentan con medidas de 211 sensores en cada ciclo.
El motor funciona normalmente al inicio de cada serie de tiempo y comienza a degradarse en algún momento durante la serie. El objetivo será crear la función de supervivencia para los motores donde el evento de falla será cuando el motor no pueda seguir funcionando y tenga que ser mandado a mantenimiento.

## Análisis de Datos
Nuestra base de datos cuenta con 75,738 registros correspondientes a 436 motores, donde cada registro corresponde a un ciclo de un motor en específico e incluye las configuraciones iniciales del ciclo así como las mediciones de los sensores.

Contamos con 50% de censura por la derecha, donde si el motor no tiene censura su último registro será del último ciclo antes de mantenimiento. En la siguiente gráfica podemos observar la distribución del tiempo en que cada motor está en funcionamiento o en qué ciclo se detuvieron las mediciones, es decir en qué ciclo la censura comenzó.

```{r}
datos %>% 
  filter(delta == 1) %>% 
  select(id, ciclo) %>% 
  mutate(
    id = gsub("e(.*)", "\\1", id) %>% as.numeric
  ) %>% 
  group_by(id) %>% 
  summarise(ciclo = max(ciclo)) %>% 
  ggplot(
    aes(
      y = ciclo,
      x = reorder(id, ciclo)
    )
  ) +
  geom_bar(
    stat = "identity",
    fill = "#011f4b",
    colour = "#011f4b"
  ) +
  coord_flip() +
  theme_gdocs() +
  theme(
    axis.text.y  = element_blank(),
  ) +
  labs(
    y = "Número de Ciclos",
    x = "Motores",
    title = "Datos sin censura"
  )
```

Para el caso de motores sin censura, en la siguiente gráfica podemos observar la distribución del tiempo en que cada motor está en funcionamiento y en qué ciclo es mandado a mantenimiento dada una falla.

```{r}
datos %>% 
  filter(delta == 0) %>% 
  select(id, ciclo) %>% 
  mutate(
    id = gsub("c(.*)", "\\1", id) %>% as.numeric
  ) %>% 
  group_by(id) %>% 
  summarise(ciclo = max(ciclo)) %>% 
  ggplot(
    aes(
      y = ciclo,
      x = reorder(id, ciclo)
    )
  ) +
  geom_bar(
    stat = "identity",
    fill = "#011f4b",
    colour = "#011f4b"
  ) +
  coord_flip() +
  theme_gdocs() +
  theme(
    axis.text.y  = element_blank(),
  ) +
  labs(
    y = "Número de Ciclos",
    x = "Motores",
    title = "Datos con censura"
  )
```



# COSO EDA

Contamos con 75,738 registros de ciclos de motores
```{r}
datos <- read_rds(
  here::here("datos/datos.rds")
) %>% 
  select("id":"sensor_21", "delta")
nrow(datos)
```

No tenemos registros con NA's
```{r}
datos[is.na(datos),]
```

Tampoco tenemos registros duplicados
```{r}
datos[duplicated(datos), ]
```

Nuestro archivo cuenta con 29 columnas:
- ID: El identificador único por motor
- Ciclo: Indica de qué ciclo son las leturas pertenecientes a la motor indicada en el campo "ID"
- Conf_[n]: Con n = 1,2,3. Configuración hecha por el operador al inicio del ciclo de la motor
- Sensor_[m]: Con m = 1,2,...,21. Lectura de sensores
- Delta: Indica si los registros contienen censura (0) o no (1)
```{r}
glimpse(datos)
```

Analizando cada variable.

ID: Nuestra base cuenta con registros de 436 motores
```{r}
datos$id <- as.factor(datos$id)

length(levels(datos$id))
```

Delta: De las 436 motores, el 50% (218) cuenta con censura a la derecha y el otro 50% de motores tiene datos exactos
```{r}
sqldf("select count(distinct id) as maquinas
      from datos 
      where delta=1")

```


Ciclo: Analizando solo los datos exactos vemos que la cantidad mìnima de ciclos es 128 y la máxima es 357, 
además su distribución está sesgada a la derecha alrededor de 209 ciclos
```{r}
ciclos <- datos %>% filter(delta==1) %>% count(id) %>% select(maquina=id, ciclos=n)
summary(ciclos)
```

```{r}
ggplot(ciclos) + 
  geom_histogram(aes(x = ciclos, y = (..count..)/sum(..count..)), 
                 bins = 15, fill = "#6497b1", colour = "black", ) +
  theme_gdocs() +
  labs(title = "Número de ciclos hasta mantenimiento",
       subtitle = "Datos exactos (Sin censura)",
       x = "Número de ciclos hasta mantenimiento", 
       y = "Frecuencia Relativa")  

```

Veamos que como es esperado las maquinas con censura tienen una cantidad de ciclos menor a la de los registros sin censura 
```{r}
tciclos <- sqldf("select distinct delta, id as maquina, count(distinct ciclo) as ciclos
                 from datos
                 group by 1,2")

rep.col<-function(x,n){
   matrix(rep(x,each=n), ncol=n, byrow=TRUE)
}

ciclo_max <- max(tciclos$ciclos)
nmaquinas <- nrow(tciclos)

ciclos_detalle <- cbind(tciclos$ciclos[[1]],tciclos$delta[[1]],tciclos$maquina[[1]],as.data.frame(rep.col(1, tciclos$ciclos[[1]])),as.data.frame(rep.col(0,ciclo_max-tciclos$ciclos[[1]])))
colnames(ciclos_detalle) <- c("ciclos","delta","maquina",paste("ciclo_",1:ciclo_max,sep="")) 

for (i in 2:nmaquinas) {
  if(tciclos$ciclos[[i]]!=ciclo_max) {
    aux <- cbind(tciclos$ciclos[[i]],tciclos$delta[[i]],tciclos$maquina[[i]],as.data.frame(rep.col(1, tciclos$ciclos[[i]])),as.data.frame(rep.col(0,ciclo_max-tciclos$ciclos[[i]]))) }
  else {
    aux <- cbind(tciclos$ciclos[[i]],tciclos$delta[[i]],tciclos$maquina[[i]],as.data.frame(rep.col(1, tciclos$ciclos[[i]])))
  }
  colnames(aux) <- c("ciclos","delta","maquina",paste("ciclo_",1:ciclo_max,sep="")) 
  ciclos_detalle <- rbind(ciclos_detalle, aux)
}

ciclos_seq <- seqdef(ciclos_detalle, 4:(ciclo_max+3), labels = c('censura','funcionando'), 
                     cpal = c("#b3cde0", "#011f4b"))

seqiplot(ciclos_seq, idxs=0, sortv=ciclos_detalle$ciclos, border=NA, space=0, with.legend=F, 
         group=ciclos_detalle$delta, main='Ciclos en funcionamiento') 
seqlegend(ciclos_seq) 

```


Conf_[n]: Los operadores realizan tres configuraciones antes de cada ciclo.

```{r}
summary(datos %>% select(conf_1, conf_2, conf_3))
```

```{r}
ggplot(datos %>% filter(id=='e5'), aes(ciclo)) +
  geom_line(aes(y = conf_1, colour = "conf_1")) + 
  geom_line(aes(y = conf_2, colour = "conf_2")) + 
  geom_line(aes(y = conf_3, colour = "conf_3")) + 
  theme_gdocs() +
  labs(title = "Configuraciones previas al ciclo",
       subtitle = "Ejemplo: motor e5",
       x = "Ciclo", 
       y = "Configuración")  
```



```{r}
conf1 <- melt(datos, id.vars='id', measure.vars=c('conf_1','conf_2', 'conf_3'))

ggplot(conf1, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Configuración previa al ciclo",
       subtitle = "Todos los ciclos",
       x = "Tipo de configuración", 
       y = "Valor establecido para la configuración")

```


```{r}
conf2 <- melt(datos, id.vars='id', measure.vars=c('conf_2'))

ggplot(conf2, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Configuración 2",
       subtitle = "Todos los ciclos",
       x = "Tipo de configuración", 
       y = "Valor establecido para la configuración")

```


Sensores

```{r}
summary(datos[6:26])
```

```{r}
datos %>% 
  filter(id == "e5") %>% 
  select(-c(id, starts_with("conf"), delta)) %>% 
  gather(
    key, 
    value, 
    -ciclo
  ) %>% 
  mutate(
    key = gsub("sensor_(.*)", "Sensor \\1", key )
  ) %>% 
  ggplot(
    aes(
      x = ciclo,
      y = value, 
      colour = key
    )
  ) +
  geom_line() +
  theme_gdocs() +
  labs(
    title = "Lectura de sensores por ciclo",
    subtitle = "Ejemplo: motor e5",
    x = "Ciclo", 
    y = "Lectura de Sensor",
    colour = "Sensor"
  )  
```


```{r}

sensor1 <- melt(datos, id.vars='id', measure.vars=colnames(datos)[6:26])

ggplot(sensor1, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor2 <- melt(datos, id.vars='id', measure.vars=c('sensor_16'))

ggplot(sensor2, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensor 16",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor3 <- melt(datos, id.vars='id', measure.vars=c('sensor_10'))

ggplot(sensor3, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensor 10",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor4 <- melt(datos, id.vars='id', measure.vars=c('sensor_05', 'sensor_06', 'sensor_15'))

ggplot(sensor4, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores 5, 6 y 15",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor5 <- melt(datos, id.vars='id', measure.vars=c('sensor_11', 'sensor_20', 'sensor_21'))

ggplot(sensor5, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores 11, 20 y 21",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```



```{r}
sensor6 <- melt(datos, id.vars='id', measure.vars=c('sensor_19'))

ggplot(sensor6, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensor 19",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor7 <- melt(datos, id.vars='id', measure.vars=c('sensor_01', 'sensor_02', 'sensor_07', 'sensor_12', 'sensor_17'))

ggplot(sensor7, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores 1, 2, 7, 12 y 17",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor8 <- melt(datos, id.vars='id', measure.vars=c('sensor_03', 'sensor_04'))

ggplot(sensor8, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores 3 y 4",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor9 <- melt(datos, id.vars='id', measure.vars=c('sensor_08', 'sensor_13', 'sensor_18'))

ggplot(sensor9, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores 8, 13 y 18",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```


```{r}
sensor10 <- melt(datos, id.vars='id', measure.vars=c('sensor_09', 'sensor_14'))

ggplot(sensor10, aes(x=variable, y=value)) + 
  geom_boxplot(fill = "#6497b1") +
  theme_gdocs() +
  coord_flip() +
  labs(title = "Medición de sensores 9 y 14",
       subtitle = "Todos los ciclos",
       x = "Sensor", 
       y = "Lectura del Sensor")

```













